MongoDB Aggregation & Query ì •ë¦¬ (í—·ê°ˆë¦¬ë˜ ë¶€ë¶„ ì§‘ì¤‘)
ğŸ“Œ 1. find() ì™€ aggregate() ì°¨ì´

MongoDBì—ì„œ ê°€ì¥ ë§ì´ í—·ê°ˆë¦¬ëŠ” ë¶€ë¶„.

âœ” find()

ë‹¨ìˆœ ê²€ìƒ‰

í•„í„°ë§, projection, ì •ë ¬ ê°€ëŠ¥

ê³„ì‚°/ì§‘ê³„ëŠ” ê±°ì˜ ë¶ˆê°€ëŠ¥

SQL ê¸°ì¤€ â†’ SELECT ... FROM ... WHERE ...

ì˜ˆ)

col.find({"age": {"$gt": 20}}, {"name": 1}).sort("age", 1)

âœ” aggregate()

ì—¬ëŸ¬ ë‹¨ê³„ë¥¼ ê±°ì³ ë°ì´í„°ë¥¼ ê°€ê³µí•  ìˆ˜ ìˆìŒ

$group, $project, $sort, $limit, $addFields ë“± ë‹¤ì–‘í•œ ê¸°ëŠ¥

SQL ê¸°ì¤€ â†’ SELECT + GROUP BY + HAVING + ORDER BY + LIMIT ëª¨ë‘ ê°€ëŠ¥

ì—‘ì…€ì—ì„œ â€œí”¼ë²— í…Œì´ë¸” + í•¨ìˆ˜â€ê¹Œì§€ í•©ì¹œ ëŠë‚Œ

ì˜ˆ)

col.aggregate([
    {"$match": {"age": {"$gt": 20}}},
    {"$group": {"_id": "$job", "count": {"$sum": 1}}},
    {"$sort": {"count": -1}}
])

ğŸ“Œ 2. aggregation operator(í—·ê°ˆë ¸ë˜ ë¶€ë¶„)
âœ” $match

ë°ì´í„° í•„í„°ë§

find() ì˜ WHERE ì ˆ ê°™ì€ ì—­í• 

í•­ìƒ ì²« ë‹¨ê³„ë¡œ ì‚¬ìš©í•˜ë©´ ì„±ëŠ¥ì´ ì¢‹ìŒ

ì‚¬ìš© ì˜ˆ:

{"$match": {"heart_rate": {"$gt": 150}}}

âœ” $project

í•„ìš”í•œ fieldë§Œ ì„ íƒ

SQL ê¸°ì¤€ â†’ SELECT field1, field2

í•„ë“œ ìˆ¨ê¸°ê¸°/ë³´ì´ê¸° ê°€ëŠ¥

ìƒˆë¡œìš´ í•„ë“œë¥¼ ê³„ì‚°í•´ ë§Œë“¤ ìˆ˜ë„ ìˆë‹¤

ì˜ˆ)

{
  "$project": {
    "_id": 0,
    "timestamp": 1,
    "activity": 1,
    "high": {"$gt": ["$heart_rate", 150]}
  }
}

âœ” $group

ì—¬ê¸°ì„œ í—·ê°ˆë¦¼ì´ ê°€ì¥ ë§ì•˜ìŒ!!

ì¤‘ìš”í•œ ê·œì¹™

$groupì—ì„œ _id ê°’ì€ ê·¸ë£¹ ê¸°ì¤€

"_id": "$activity" â†’ í™œë™ë³„ ê·¸ë£¹

$sum, $avg ë“±ì€ ê³„ì‚°ì‹ì´ë©°, ë¬¸ì„œì˜ ê°’ì„ ì§ì ‘ ê°€ì ¸ì˜¤ëŠ” ê²ƒì´ ì•„ë‹˜

ğŸš« í‹€ë¦° ì˜ˆ (ë‹¹ì‹ ì´ ì²˜ìŒ ì‘ì„±í•œ ì½”ë“œ)

"_id": "activity" 


â†’ ì´ë ‡ê²Œ ì“°ë©´ ë¬¸ìì—´ "activity" ë¡œ ê·¸ë£¹ë¨ â†’ activity ê°’ê³¼ ìƒê´€ ì—†ìŒ

âœ” ì˜¬ë°”ë¥¸ ì˜ˆ

"_id": "$activity"

âœ” $sum

$group ì•ˆì—ì„œë§Œ ì˜ë¯¸ ìˆëŠ” ì—°ì‚°ì.

ì˜ˆ	ì˜ë¯¸
{"$sum": 1}	ë¬¸ì„œ 1ê°œë‹¹ +1 â†’ ê°œìˆ˜ ì„¸ê¸°(count)
{"$sum": "$activity"}	activity ê°’ì„ ëª¨ë‘ í•©ì‚°
âœ” $push

ê·¸ë£¹ ë‚´ë¶€ì— ë°°ì—´ì„ ë§Œë“œëŠ” ê¸°ëŠ¥

ê°’ë“¤ì„ í•˜ë‚˜ì˜ ë°°ì—´ë¡œ ëª¨ìŒ

ì˜ˆ)

"timestamps": {"$push": "$timestamp"}


ì¶œë ¥ ì˜ˆì‹œ:

[
  datetime(...),
  datetime(...),
  ...
]


ğŸ‘‰ ì´ ì¶œë ¥ì´ ë§ëŠ” ì´ìœ : high heart_rate ë°œìƒ ì‹œê°ì„ ëª¨ë‘ ëª¨ì•„ ë°°ì—´ë¡œ ë§Œë“  ê²ƒì„.

ğŸ“Œ 3. ìì£¼ í—·ê°ˆë ¸ë˜ ì‹¤ìˆ˜ ì •ë¦¬
âŒ (1) $groupì˜ _idì— ë¬¸ìì—´ ë„£ìŒ
"_id": "activity"


â†’ activityë¼ëŠ” ê¸€ì ë¬¸ìì—´ë¡œ ê·¸ë£¹ë¨
âœ” ì •ë‹µ:

"_id": "$activity"

âŒ (2) $sum ì„ $project ì•ˆì—ì„œ ì‚¬ìš©í•œ ê²½ìš°
"high_rate_count": {"$sum": "activity"}  # í‹€ë¦¼


âœ” $sum ì€ $group ì—ì„œë§Œ ì‚¬ìš© ê°€ëŠ¥

âŒ (3) find() ê²°ê³¼ì—ì„œ .matched_count ì‚¬ìš©í•˜ë ¤ í–ˆë˜ ì 

.matched_count ëŠ” update_one, update_many ì˜ ê²°ê³¼ì—ì„œë§Œ ì‚¬ìš© ê°€ëŠ¥

find() â†’ cursor

aggregate() â†’ cursor

countëŠ” ì•„ë˜ì²˜ëŸ¼ í•´ì•¼ í•¨:

âœ” ë°©ë²• 1

col.count_documents({"body_temp": {"$gte": 38}})


âœ” ë°©ë²• 2 (cursor ì‚¬ìš©)

result = col.find({...})
print(len(list(result)))

ê²°ë¡ !!!!
ê·¸ë£¹í™”í•˜ë ¤ë©´ _id: "$í•„ë“œëª…" ì´ë‹¤.
$sum, $avg ê°™ì€ ê³„ì‚° ì—°ì‚°ìëŠ” $group ì•ˆì—ì„œë§Œ ì‚¬ìš©í•œë‹¤.
$push ëŠ” â€œê°’ë“¤ì„ ë°°ì—´ì— ëª¨ìœ¼ëŠ” ê¸°ëŠ¥â€
.matched_count ëŠ” update ê²°ê³¼ì—ì„œë§Œ ì“¸ ìˆ˜ ìˆë‹¤
ê¸°ë³¸ì€ find(), ë³µì¡í•´ì§€ë©´ aggregate()
